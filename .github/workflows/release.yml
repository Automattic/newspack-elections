name: Create a release for GitHub when NOT deploying to WP.ORG

on:
  push:
    tags:
      - "v*.*.*-*"
permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    
    - uses: actions/checkout@v4
    #- name: Validate composer.json and composer.lock
      #run: composer validate --strict

    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install Composer Dependencies
      run: composer install --prefer-dist --no-progress --no-dev
      
    - name: Cache NPM packages
      id: npm-cache
      uses: actions/cache@v4
      with:
        path: node_modules
        key: ${{ runner.os }}-php-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-js-
      
    - name: Install NPM Dependencies
      run: |
        npm install
    
    - name: Build NPM Dependencies
      run: |
        npm run build

    - name: Rename readme from md to txt
      run: |
       mv README.md readme.txt
    
    #- name: WordPress Plugin Deploy
    #  id: deploy
    #  uses: 10up/action-wordpress-plugin-deploy@stable
    #  with:
    #    generate-zip: true
    #  env:
    #    SVN_USERNAME: ${{ secrets.SVN_USERNAME }}
    #    SVN_PASSWORD: ${{ secrets.SVN_PASSWORD }}
    #    ASSETS_DIR: "assets"git
    #    SLUG: "govpack"
        
    - name: Create a Zip
      run: |
          zip -r "${GITHUB_WORKSPACE}/govpack.zip" . -x @.distignore

    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        # note you'll typically need to create a personal access token
        # with permissions to create releases in the other repo
        token: ${{ secrets.RELEASE_TOKEN }}
        files: "govpack.zip"
      env: 
        GITHUB_REPOSITORY: "govpack-wp/govpack-plugin"

